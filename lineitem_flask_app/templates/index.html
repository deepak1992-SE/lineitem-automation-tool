
<!DOCTYPE html>
<html>
<head>
    <title>Line Item Creator - PubMatic</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #f7f8fa;
            margin: 0;
            color: #222;
        }
        .sidebar {
            width: 220px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            padding: 32px 0 0 0;
        }
        .sidebar .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #0096e6;
            margin-left: 32px;
            margin-bottom: 40px;
        }
        .main {
            margin-left: 240px;
            padding: 40px 32px;
        }
        .form-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 32px;
            max-width: 600px;
            margin: auto;
        }
        h2 {
            color: #0096e6;
            margin-bottom: 24px;
        }
        label {
            font-weight: 600;
            margin-top: 16px;
            display: block;
        }
        input[type=text], input[type=email], input[type=number], select, input[type=file] {
            width: 100%;
            padding: 10px 12px;
            margin-top: 6px;
            margin-bottom: 18px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        input[type=checkbox] {
            margin-right: 8px;
        }
        .submit-btn {
            background: #0096e6;
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        .submit-btn:hover {
            background: #007bb5;
        }
        .messages {
            margin-bottom: 24px;
            color: #d32f2f;
        }
        .divider {
            border-bottom: 1px solid #e5e7eb;
            margin: 24px 0;
        }
        .optional {
            color: gray;
            font-weight: 400;
            font-size: 0.98em;
        }
        .required {
            color: red;
        }
        .add-row-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .add-row-btn:hover {
            background: #218838;
        }
        #ranges-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        #ranges-table td {
            padding: 4px;
            border-bottom: 1px solid #dee2e6;
        }
        #ranges-table input, #ranges-table select {
            margin: 0;
            padding: 6px 8px;
            font-size: 0.9em;
        }
        #ranges-table button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        #ranges-table button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Pub<span style="color:#222">Matic</span></div>
        <div style="margin-left:32px; color:#888; font-size:1.1rem;">Line Item Automation</div>
    </div>
    <div class="main">
        <div class="form-card">
            <h2>Line Item Creator</h2>
            <p><strong>Mandatory fields are marked with <span class="required">*</span></strong></p>
            <form method="POST" enctype="multipart/form-data">
                <!-- Order Name: Mandatory -->
                <label>Order Name: <span class="required">*</span></label>
                <input type="text" name="order_name" value="" required>

                <!-- User Email: Mandatory -->
                <label>User Email: <span class="required">*</span></label>
                <input type="email" name="user_email" value="" required>

                <!-- Advertiser Name: Mandatory -->
                <label>Advertiser Name: <span class="required">*</span></label>
                <input type="text" name="advertiser_name" value="{{ form_data.advertiser_name if form_data and form_data.advertiser_name is defined else settings.DFP_ADVERTISER_NAME }}" required>

                <!-- Network Code: Mandatory -->
                <label>Network Code: <span class="required">*</span></label>
                <input type="text" name="network_code" value="{{ form_data.network_code if form_data and form_data.network_code is defined else '' }}" required>

                <!-- Line Item Name Prefix: Optional -->
                <label>Line Item Name Prefix: <span class="optional">(Optional)</span></label>
                <input type="text" name="lineitem_prefix" value="{{ form_data.lineitem_prefix if form_data and form_data.lineitem_prefix is defined else '' }}">

                <!-- Line Item Type: Mandatory -->
                <label>Line Item Type: <span class="required">*</span></label>
                <select name="lineitem_type" required>
                    <option value="NETWORK" {% if (form_data and form_data.lineitem_type == 'NETWORK') or (not form_data and settings.DFP_LINEITEM_TYPE == 'NETWORK') %}selected{% endif %}>NETWORK</option>
                    <option value="HOUSE" {% if (form_data and form_data.lineitem_type == 'HOUSE') or (not form_data and settings.DFP_LINEITEM_TYPE == 'HOUSE') %}selected{% endif %}>HOUSE</option>
                    <option value="PRICE_PRIORITY" {% if (form_data and form_data.lineitem_type == 'PRICE_PRIORITY') or (not form_data and settings.DFP_LINEITEM_TYPE == 'PRICE_PRIORITY') %}selected{% endif %}>PRICE_PRIORITY</option>
                    <option value="SPONSORSHIP" {% if (form_data and form_data.lineitem_type == 'SPONSORSHIP') or (not form_data and settings.DFP_LINEITEM_TYPE == 'SPONSORSHIP') %}selected{% endif %}>SPONSORSHIP</option>
                </select>

                <!-- OpenWrap Creative Type: Optional -->
                <label>OpenWrap Creative Type: <span class="optional">(Optional)</span></label>
                <select name="openwrap_setup_type">
                    {% set creative_type = form_data.openwrap_setup_type if form_data and form_data.openwrap_setup_type is defined else 'WEB' %}
                    <option value="WEB" {% if creative_type == 'WEB' %}selected{% endif %}>WEB</option>
                    <option value="WEB_SAFEFRAME" {% if creative_type == 'WEB_SAFEFRAME' %}selected{% endif %}>WEB_SAFEFRAME</option>
                    <option value="AMP" {% if creative_type == 'AMP' %}selected{% endif %}>AMP</option>
                    <option value="IN_APP" {% if creative_type == 'IN_APP' %}selected{% endif %}>IN_APP</option>
                    <option value="IN_APP_VIDEO" {% if creative_type == 'IN_APP_VIDEO' %}selected{% endif %}>IN_APP_VIDEO</option>
                    <option value="IN_APP_NATIVE" {% if creative_type == 'IN_APP_NATIVE' %}selected{% endif %}>IN_APP_NATIVE</option>
                    <option value="NATIVE" {% if creative_type == 'NATIVE' %}selected{% endif %}>NATIVE</option>
                    <option value="VIDEO" {% if creative_type == 'VIDEO' %}selected{% endif %}>VIDEO</option>
                    <option value="JWPLAYER" {% if creative_type == 'JWPLAYER' %}selected{% endif %}>JWPLAYER</option>
                    <option value="ADPOD" {% if creative_type == 'ADPOD' %}selected{% endif %}>ADPOD</option>
                </select>

                <!-- Bidder Code: Optional -->
                <label>Bidder Code (pwtpid): <span class="optional">(Optional)</span></label>
                <input type="text" name="bidder_code" value="{{ form_data.bidder_code if form_data and form_data.bidder_code is defined else '' }}" placeholder="e.g., pubmatic, appnexus, rubicon">
                <small style="color: #666; font-size: 0.9em; display: block; margin-top: -12px; margin-bottom: 18px;">
                    Enter the bidder code to target specific demand partners. Leave empty to target all bidders.
                </small>

                <!-- Creative Sizes: Mandatory -->
                <label>Creative Sizes (comma separated, e.g. 300x250,728x90): <span class="required">*</span></label>
                <input type="text" name="creative_sizes" value="" required>

                <!-- Number of Creatives per Line Item: Optional -->
                <label>Number of Creatives per Line Item: <span class="optional">(Optional)</span></label>
                <input type="number" name="num_creatives" value="{{ form_data.num_creatives if form_data and form_data.num_creatives is defined else settings.DFP_NUM_CREATIVES_PER_LINE_ITEM }}">

                <!-- Currency Code: Optional -->
                <label>Currency Code: <span class="optional">(Optional)</span></label>
                <input type="text" name="currency_code" value="{{ form_data.currency_code if form_data and form_data.currency_code is defined else settings.DFP_CURRENCY_CODE }}">

                <!-- Currency Exchange: Optional -->
                <label>Currency Exchange: <span class="optional">(Optional)</span></label>
                <input type="checkbox" name="currency_exchange" {% if form_data and form_data.currency_exchange %}checked{% elif not form_data and settings.CURRENCY_EXCHANGE %}checked{% endif %}>

                <!-- Target Currency: Optional (only shown when Currency Exchange is enabled) -->
                <div id="target_currency_section" style="display: none;">
                    <label>Target Currency: <span class="optional">(Required when Currency Exchange is enabled)</span></label>
                    <input type="text" name="target_currency" value="{{ form_data.target_currency if form_data and form_data.target_currency is defined else settings.TARGET_CURRENCY }}" placeholder="e.g., INR, EUR, GBP, JPY">
                    <small style="color: #666; font-size: 0.9em;">Supported currencies: USD, INR, EUR, GBP, JPY</small>
                </div>

                <!-- Placement Name: Optional -->
                <label>Placement Name(s): <span class="optional">(Optional, comma-separated for multiple)</span></label>
                <input type="text" name="placement_names" value="{{ form_data.placement_names if form_data and form_data.placement_names is defined else '' }}">

                <!-- Line Item Ranges: -->
                <label>Line Item Ranges:</label>
                <small style="color: #666; font-size: 0.9em; display: block; margin-bottom: 8px;">
                    üí° <strong>Granularity Tips:</strong> Use positive values (e.g., 0.01, 0.05, 0.10) for price increments, or -1 for catch-all buckets that target entire ranges.
                </small>
                <table id="ranges-table" style="width:100%; margin-bottom:18px; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Start Range</th>
                            <th>End Range</th>
                            <th>Granularity</th>
                            <th>Rate ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if form_data and form_data.ranges_count is defined and form_data.ranges_count|int > 0 %}
                            {% for i in range(form_data.ranges_count|int) %}
                            <tr>
                                <td><input type="number" step="any" name="start_range_{{i}}" value="{{ form_data['start_range_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="end_range_{{i}}" value="{{ form_data['end_range_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="granularity_{{i}}" value="{{ form_data['granularity_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td>
                                    <select name="rate_id_{{i}}" required>
                                        <option value="1" {% if form_data['rate_id_' ~ i] == '1' %}selected{% endif %}>1 (Average)</option>
                                        <option value="2" {% if form_data['rate_id_' ~ i] == '2' %}selected{% endif %}>2 (Minimum)</option>
                                    </select>
                                </td>
                                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td><input type="number" step="any" name="start_range_0" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="end_range_0" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="granularity_0" required oninput="calculateTotals()"></td>
                                <td>
                                    <select name="rate_id_0" required>
                                        <option value="1">1 (Average)</option>
                                        <option value="2">2 (Minimum)</option>
                                    </select>
                                </td>
                                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                <input type="hidden" id="ranges_count" name="ranges_count" value="{{ form_data.ranges_count if form_data and form_data.ranges_count is defined else 1 }}">
                <button type="button" onclick="addRow()" class="add-row-btn">Add Row</button>
                
                <!-- Calculation Display -->
                <div id="calculation-display" style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0096e6;">
                    <h4 style="margin: 0 0 12px 0; color: #0096e6; font-size: 1.1em;">üìä Calculation Summary</h4>
                    <div id="calculation-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <strong>Line Items:</strong> <span id="lineitem-count">0</span>
                                <div style="font-size: 0.9em; color: #666;">Max per order: 450</div>
                            </div>
                            <div>
                                <strong>Total Creatives:</strong> <span id="creative-count">0</span>
                                <div style="font-size: 0.9em; color: #666;">Max per advertiser: 10,000</div>
                            </div>
                        </div>
                        <div id="limit-warnings" style="margin-top: 12px;"></div>
                        <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                            üìñ <a href="https://support.google.com/admanager/answer/1628457?hl=en" target="_blank" style="color: #0096e6;">Google Ad Manager Limits Documentation</a>
                        </div>
                    </div>
                </div>
                <script>
                // Currency exchange toggle functionality
                document.addEventListener('DOMContentLoaded', function() {
                    const currencyExchangeCheckbox = document.querySelector('input[name="currency_exchange"]');
                    const targetCurrencySection = document.getElementById('target_currency_section');
                    
                    function toggleTargetCurrency() {
                        if (currencyExchangeCheckbox.checked) {
                            targetCurrencySection.style.display = 'block';
                        } else {
                            targetCurrencySection.style.display = 'none';
                        }
                    }
                    
                    // Initial state
                    toggleTargetCurrency();
                    
                    // Add event listener
                    currencyExchangeCheckbox.addEventListener('change', toggleTargetCurrency);
                });
                
                function addRow() {
                    var table = document.getElementById('ranges-table').getElementsByTagName('tbody')[0];
                    var rowCount = table.rows.length;
                    var row = table.insertRow(-1);
                    row.innerHTML = `
                        <td><input type="number" step="any" name="start_range_${rowCount}" required oninput="calculateTotals()"></td>
                        <td><input type="number" step="any" name="end_range_${rowCount}" required oninput="calculateTotals()"></td>
                        <td><input type="number" step="any" name="granularity_${rowCount}" required oninput="calculateTotals()"></td>
                        <td>
                            <select name="rate_id_${rowCount}" required>
                                <option value="1">1 (Average)</option>
                                <option value="2">2 (Minimum)</option>
                            </select>
                        </td>
                        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                    `;
                    document.getElementById('ranges_count').value = rowCount + 1;
                    calculateTotals();
                }
                function removeRow(btn) {
                    var row = btn.parentNode.parentNode;
                    var table = row.parentNode;
                    table.removeChild(row);
                    // Re-index names
                    var rows = table.getElementsByTagName('tr');
                    for (var i = 0; i < rows.length; i++) {
                        var inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length > 0) inputs[0].name = 'start_range_' + i;
                        if (inputs.length > 1) inputs[1].name = 'end_range_' + i;
                        if (inputs.length > 2) inputs[2].name = 'granularity_' + i;
                        var selects = rows[i].getElementsByTagName('select');
                        if (selects.length > 0) selects[0].name = 'rate_id_' + i;
                    }
                    document.getElementById('ranges_count').value = rows.length;
                    calculateTotals();
                }
                
                function calculateTotals() {
                    const table = document.getElementById('ranges-table').getElementsByTagName('tbody')[0];
                    const rows = table.getElementsByTagName('tr');
                    let totalLineItems = 0;
                    let hasErrors = false;
                    
                    for (let i = 0; i < rows.length; i++) {
                        const inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length >= 3) {
                            const startRange = parseFloat(inputs[0].value) || 0;
                            const endRange = parseFloat(inputs[1].value) || 0;
                            const granularity = parseFloat(inputs[2].value) || 0;
                            
                            if (startRange > 0 && endRange > 0 && granularity !== 0) {
                                if (granularity === -1) {
                                    // Catch-all: one line item for the whole range
                                    totalLineItems += 1;
                                } else if (granularity > 0) {
                                    // Calculate number of buckets based on actual backend logic
                                    let current = startRange;
                                    let bucketCount = 0;
                                    while (current <= endRange + 0.00001) { // small epsilon for float precision
                                        bucketCount++;
                                        current += granularity;
                                    }
                                    totalLineItems += Math.max(1, bucketCount);
                                }
                            }
                        }
                    }
                    
                    // Get number of creatives per line item
                    const numCreativesInput = document.querySelector('input[name="num_creatives"]');
                    const numCreatives = parseInt(numCreativesInput?.value) || 1;
                    const totalCreatives = totalLineItems * numCreatives;
                    
                    // Update display
                    document.getElementById('lineitem-count').textContent = totalLineItems;
                    document.getElementById('creative-count').textContent = totalCreatives;
                    
                    // Check limits and show warnings
                    const warningsDiv = document.getElementById('limit-warnings');
                    let warnings = [];
                    
                    // Google Ad Manager limits
                    const MAX_LINE_ITEMS_PER_ORDER = 450;
                    const MAX_CREATIVES_PER_ADVERTISER = 10000;
                    
                    if (totalLineItems > MAX_LINE_ITEMS_PER_ORDER) {
                        warnings.push(`‚ö†Ô∏è <strong>Line Items Limit Exceeded:</strong> ${totalLineItems} line items exceed the maximum of ${MAX_LINE_ITEMS_PER_ORDER} per order.`);
                    }
                    
                    if (totalCreatives > MAX_CREATIVES_PER_ADVERTISER) {
                        warnings.push(`‚ö†Ô∏è <strong>Creatives Limit Exceeded:</strong> ${totalCreatives} creatives exceed the maximum of ${MAX_CREATIVES_PER_ADVERTISER} per advertiser.`);
                    }
                    
                    // Performance warnings
                    if (totalLineItems > 200) {
                        warnings.push(`üí° <strong>Performance Note:</strong> ${totalLineItems} line items may impact performance. Consider reducing granularity.`);
                    }
                    
                    if (warnings.length > 0) {
                        warningsDiv.innerHTML = warnings.map(w => `<div style="margin: 4px 0; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9em;">${w}</div>`).join('');
                    } else if (totalLineItems > 0) {
                        warningsDiv.innerHTML = '<div style="margin: 4px 0; padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 0.9em; color: #155724;">‚úÖ <strong>All limits OK!</strong> Ready to create line items.</div>';
                    } else {
                        warningsDiv.innerHTML = '';
                    }
                }
                
                // Add event listeners to existing inputs
                document.addEventListener('DOMContentLoaded', function() {
                    // Add calculation triggers to existing range inputs
                    const rangeInputs = document.querySelectorAll('input[name^="start_range_"], input[name^="end_range_"], input[name^="granularity_"]');
                    rangeInputs.forEach(input => {
                        input.addEventListener('input', calculateTotals);
                    });
                    
                    // Add calculation trigger to num_creatives input
                    const numCreativesInput = document.querySelector('input[name="num_creatives"]');
                    if (numCreativesInput) {
                        numCreativesInput.addEventListener('input', calculateTotals);
                    }
                    
                    // Initial calculation
                    calculateTotals();
                });
                </script>

                <!-- Progress Bar -->
                <div id="progress-container" style="display:none; margin-bottom:18px;">
                  <div style="background:#e5e7eb; border-radius:6px; height:24px; width:100%; overflow:hidden;">
                    <div id="progress-bar" style="height:100%; width:0%; background:#0096e6; color:#fff; text-align:center; line-height:24px; font-weight:600; transition:width 0.3s; border-radius:6px;">0%</div>
                  </div>
                </div>
                <input class="submit-btn" id="submit-btn" type="submit" value="Create Line Items">
            </form>
            <script>
            // Progress bar logic
            const form = document.querySelector('form');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const submitBtn = document.getElementById('submit-btn');
            let progress = 0;
            let interval = null;
            form.addEventListener('submit', function(e) {
                progress = 0;
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressContainer.style.display = 'block';
                submitBtn.disabled = true;
                // Simulate progress up to 90% while waiting for backend
                interval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 5 + 2; // 2-7% increments
                        if (progress > 90) progress = 90;
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = Math.floor(progress) + '%';
                    }
                }, 300);
            });
            // On page load, if progress bar is visible, set to 100%
            window.addEventListener('pageshow', function() {
                if (progressContainer.style.display === 'block') {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    submitBtn.disabled = false;
                }
            });
            </script>
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  {% if category == 'success' %}
                    <div style="margin: 18px 0; padding: 12px; background: #e6f7e6; color: #207520; border-radius: 6px; font-size: 1.08em; font-weight: 500;">
                      {{ message }}
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endwith %}
        </div>
    </div>
</body>
</html>
