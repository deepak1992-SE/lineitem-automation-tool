
<!DOCTYPE html>
<html>
<head>
    <title>Line Item Creator - PubMatic</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #f7f8fa;
            margin: 0;
            color: #222;
        }
        .sidebar {
            width: 220px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            padding: 32px 0 0 0;
        }
        .sidebar .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #0096e6;
            margin-left: 32px;
            margin-bottom: 40px;
        }
        .sidebar a {
            transition: all 0.3s ease;
        }
        .sidebar a:hover {
            color: #007bb5 !important;
            transform: translateX(5px);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            text-align: right;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #0096e6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #007bb5;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .confirmation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .confirmation-table th,
        .confirmation-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        .confirmation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .confirmation-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .confirmation-details {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .confirmation-details h4 {
            margin: 0 0 10px 0;
            color: #0096e6;
        }
        
        .confirmation-details p {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }
        
        .confirmation-summary {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .confirmation-summary h4 {
            margin: 0 0 10px 0;
            color: #1565c0;
        }
        
        .confirmation-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .confirmation-warning h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        .confirmation-warning p {
            margin: 5px 0;
            color: #856404;
        }
        
        .main {
            margin-left: 240px;
            padding: 40px 32px;
        }
        .form-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 32px;
            max-width: 600px;
            margin: auto;
        }
        h2 {
            color: #0096e6;
            margin-bottom: 24px;
        }
        label {
            font-weight: 600;
            margin-top: 16px;
            display: block;
        }
        input[type=text], input[type=email], input[type=number], select, input[type=file] {
            width: 100%;
            padding: 10px 12px;
            margin-top: 6px;
            margin-bottom: 18px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        input[type=checkbox] {
            margin-right: 8px;
        }
        .submit-btn {
            background: #0096e6;
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        .submit-btn:hover {
            background: #007bb5;
        }
        .messages {
            margin-bottom: 24px;
            color: #d32f2f;
        }
        .divider {
            border-bottom: 1px solid #e5e7eb;
            margin: 24px 0;
        }
        .optional {
            color: gray;
            font-weight: 400;
            font-size: 0.98em;
        }
        .required {
            color: red;
        }
        .add-row-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .add-row-btn:hover {
            background: #218838;
        }
        #ranges-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        #ranges-table td {
            padding: 4px;
            border-bottom: 1px solid #dee2e6;
        }
        #ranges-table input, #ranges-table select {
            margin: 0;
            padding: 6px 8px;
            font-size: 0.9em;
        }
        #ranges-table button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        #ranges-table button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Pub<span style="color:#222">Matic</span></div>
        <div style="margin-left:32px; color:#888; font-size:1.1rem;">Line Item Automation</div>
        <div style="margin-left:32px; margin-top: 20px;">
            <a href="/logs" style="color: #0096e6; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                üìã View Logs
            </a>
        </div>
    </div>
    <div class="main">
        <div class="form-card">
            <h2>Line Item Creator</h2>
            <p><strong>Mandatory fields are marked with <span class="required">*</span></strong></p>
            <form method="POST" enctype="multipart/form-data">
                <!-- Order Name: Mandatory -->
                <label>Order Name: <span class="required">*</span></label>
                <input type="text" name="order_name" id="order_name" value="" required>

                <!-- User Email: Mandatory -->
                <label>User Email: <span class="required">*</span></label>
                <input type="email" name="user_email" value="" required>

                <!-- Advertiser Name: Mandatory -->
                <label>Advertiser Name: <span class="required">*</span></label>
                <input type="text" name="advertiser_name" id="advertiser_name" value="{{ form_data.advertiser_name if form_data and form_data.advertiser_name is defined else settings.DFP_ADVERTISER_NAME }}" required>

                <!-- Network Code: Mandatory -->
                <label>Network Code: <span class="required">*</span></label>
                <input type="text" name="network_code" value="{{ form_data.network_code if form_data and form_data.network_code is defined else '' }}" placeholder="e.g., 15671365" required>
                <small style="color: #666; font-size: 0.9em; display: block; margin-top: -12px; margin-bottom: 18px;">
                    üí° <strong>Dynamic Network Code:</strong> Enter any network code here - no need to update environment variables!
                </small>

                <!-- Line Item Name Prefix: Optional -->
                <label>Line Item Name Prefix: <span class="optional">(Optional)</span></label>
                <input type="text" name="lineitem_prefix" id="lineitem_prefix" value="{{ form_data.lineitem_prefix if form_data and form_data.lineitem_prefix is defined else '' }}">

                <!-- Line Item Type: Mandatory -->
                <label>Line Item Type: <span class="required">*</span></label>
                <select name="lineitem_type" required>
                    <option value="NETWORK" {% if (form_data and form_data.lineitem_type == 'NETWORK') or (not form_data and settings.DFP_LINEITEM_TYPE == 'NETWORK') %}selected{% endif %}>NETWORK</option>
                    <option value="HOUSE" {% if (form_data and form_data.lineitem_type == 'HOUSE') or (not form_data and settings.DFP_LINEITEM_TYPE == 'HOUSE') %}selected{% endif %}>HOUSE</option>
                    <option value="PRICE_PRIORITY" {% if (form_data and form_data.lineitem_type == 'PRICE_PRIORITY') or (not form_data and settings.DFP_LINEITEM_TYPE == 'PRICE_PRIORITY') %}selected{% endif %}>PRICE_PRIORITY</option>
                    <option value="SPONSORSHIP" {% if (form_data and form_data.lineitem_type == 'SPONSORSHIP') or (not form_data and settings.DFP_LINEITEM_TYPE == 'SPONSORSHIP') %}selected{% endif %}>SPONSORSHIP</option>
                </select>

                <!-- OpenWrap Creative Type: Optional -->
                <label>OpenWrap Creative Type: <span class="optional">(Optional)</span></label>
                <select name="openwrap_setup_type">
                    {% set creative_type = form_data.openwrap_setup_type if form_data and form_data.openwrap_setup_type is defined else 'WEB' %}
                    <option value="WEB" {% if creative_type == 'WEB' %}selected{% endif %}>WEB</option>
                    <option value="WEB_SAFEFRAME" {% if creative_type == 'WEB_SAFEFRAME' %}selected{% endif %}>WEB_SAFEFRAME</option>
                    <option value="AMP" {% if creative_type == 'AMP' %}selected{% endif %}>AMP</option>
                    <option value="IN_APP" {% if creative_type == 'IN_APP' %}selected{% endif %}>IN_APP</option>
                    <option value="IN_APP_VIDEO" {% if creative_type == 'IN_APP_VIDEO' %}selected{% endif %}>IN_APP_VIDEO</option>
                    <option value="IN_APP_NATIVE" {% if creative_type == 'IN_APP_NATIVE' %}selected{% endif %}>IN_APP_NATIVE</option>
                    <option value="NATIVE" {% if creative_type == 'NATIVE' %}selected{% endif %}>NATIVE</option>
                    <option value="VIDEO" {% if creative_type == 'VIDEO' %}selected{% endif %}>VIDEO</option>
                    <option value="JWPLAYER" {% if creative_type == 'JWPLAYER' %}selected{% endif %}>JWPLAYER</option>
                    <option value="ADPOD" {% if creative_type == 'ADPOD' %}selected{% endif %}>ADPOD</option>
                </select>

                <!-- Bidder Name: Optional -->
                <label>Bidder Name: <span class="optional">(Optional)</span></label>
                <input type="text" name="bidder_name" id="bidder_name" value="{{ form_data.bidder_name if form_data and form_data.bidder_name is defined else '' }}" placeholder="e.g., PubMatic, AppNexus, Rubicon" oninput="updateBidderFields()">
                <small style="color: #666; font-size: 0.9em; display: block; margin-top: -12px; margin-bottom: 18px;">
                    Enter the bidder name for auto-generation of order name, advertiser name, and line item prefix.
                </small>

                <!-- Bidder Code: Optional -->
                <label>Bidder Code (pwtpid): <span class="optional">(Optional)</span></label>
                <input type="text" name="bidder_code" id="bidder_code" value="{{ form_data.bidder_code if form_data and form_data.bidder_code is defined else '' }}" placeholder="e.g., pubmatic, appnexus, rubicon" oninput="updateBidderFields()">
                <small style="color: #666; font-size: 0.9em; display: block; margin-top: -12px; margin-bottom: 18px;">
                    Enter the bidder code to target specific demand partners. Leave empty to target all bidders.
                </small>

                <!-- Creative Sizes: Mandatory -->
                <label>Creative Sizes (comma separated, e.g. 300x250,728x90): <span class="required">*</span></label>
                <input type="text" name="creative_sizes" value="" required>

                <!-- Number of Creatives per Line Item: Optional -->
                <label>Number of Creatives per Line Item: <span class="optional">(Optional)</span></label>
                <input type="number" name="num_creatives" value="{{ form_data.num_creatives if form_data and form_data.num_creatives is defined else settings.DFP_NUM_CREATIVES_PER_LINE_ITEM }}">

                <!-- Currency Code: Optional -->
                <label>Currency Code: <span class="optional">(Optional)</span></label>
                <input type="text" name="currency_code" value="{{ form_data.currency_code if form_data and form_data.currency_code is defined else settings.DFP_CURRENCY_CODE }}">

                <!-- Currency Exchange: Optional -->
                <label>Currency Exchange: <span class="optional">(Optional)</span></label>
                <input type="checkbox" name="currency_exchange" {% if form_data and form_data.currency_exchange %}checked{% elif not form_data and settings.CURRENCY_EXCHANGE %}checked{% endif %}>

                <!-- Target Currency: Optional (only shown when Currency Exchange is enabled) -->
                <div id="target_currency_section" style="display: none;">
                    <label>Target Currency: <span class="optional">(Required when Currency Exchange is enabled)</span></label>
                    <input type="text" name="target_currency" value="{{ form_data.target_currency if form_data and form_data.target_currency is defined else settings.TARGET_CURRENCY }}" placeholder="e.g., INR, EUR, GBP, JPY">
                    <small style="color: #666; font-size: 0.9em;">Supported currencies: USD, INR, EUR, GBP, JPY</small>
                </div>

                <!-- Placement Name: Optional -->
                <label>Placement Name(s): <span class="optional">(Optional, comma-separated for multiple)</span></label>
                <input type="text" name="placement_names" value="{{ form_data.placement_names if form_data and form_data.placement_names is defined else '' }}">

                <!-- Line Item Ranges: -->
                <label>Line Item Ranges:</label>
                <small style="color: #666; font-size: 0.9em; display: block; margin-bottom: 8px;">
                    üí° <strong>Granularity Tips:</strong> Use positive values (e.g., 0.01, 0.05, 0.10) for price increments, or -1 for catch-all buckets that target entire ranges.
                </small>
                <table id="ranges-table" style="width:100%; margin-bottom:18px; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Start Range</th>
                            <th>End Range</th>
                            <th>Granularity</th>
                            <th>Rate ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if form_data and form_data.ranges_count is defined and form_data.ranges_count|int > 0 %}
                            {% for i in range(form_data.ranges_count|int) %}
                            <tr>
                                <td><input type="number" step="any" name="start_range_{{i}}" value="{{ form_data['start_range_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="end_range_{{i}}" value="{{ form_data['end_range_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="granularity_{{i}}" value="{{ form_data['granularity_' ~ i] }}" required oninput="calculateTotals()"></td>
                                <td>
                                    <select name="rate_id_{{i}}" required>
                                        <option value="1" {% if form_data['rate_id_' ~ i] == '1' %}selected{% endif %}>1 (Average)</option>
                                        <option value="2" {% if form_data['rate_id_' ~ i] == '2' %}selected{% endif %}>2 (Minimum)</option>
                                    </select>
                                </td>
                                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td><input type="number" step="any" name="start_range_0" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="end_range_0" required oninput="calculateTotals()"></td>
                                <td><input type="number" step="any" name="granularity_0" required oninput="calculateTotals()"></td>
                                <td>
                                    <select name="rate_id_0" required>
                                        <option value="1">1 (Average)</option>
                                        <option value="2">2 (Minimum)</option>
                                    </select>
                                </td>
                                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                <input type="hidden" id="ranges_count" name="ranges_count" value="{{ form_data.ranges_count if form_data and form_data.ranges_count is defined else 1 }}">
                <button type="button" onclick="addRow()" class="add-row-btn">Add Row</button>
                
                <!-- Calculation Display -->
                <div id="calculation-display" style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0096e6;">
                    <h4 style="margin: 0 0 12px 0; color: #0096e6; font-size: 1.1em;">üìä Calculation Summary</h4>
                    <div id="calculation-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <strong>Line Items:</strong> <span id="lineitem-count">0</span>
                                <div style="font-size: 0.9em; color: #666;">Max per order: 450</div>
                            </div>
                            <div>
                                <strong>Total Creatives:</strong> <span id="creative-count">0</span>
                                <div style="font-size: 0.9em; color: #666;">Max per advertiser: 10,000</div>
                            </div>
                        </div>
                        <div id="limit-warnings" style="margin-top: 12px;"></div>
                        <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                            üìñ <a href="https://support.google.com/admanager/answer/1628457?hl=en" target="_blank" style="color: #0096e6;">Google Ad Manager Limits Documentation</a>
                        </div>
                    </div>
                </div>
                <script>
                // Bidder fields auto-generation functionality
                function updateBidderFields() {
                    const bidderName = document.getElementById('bidder_name').value.trim();
                    const bidderCode = document.getElementById('bidder_code').value.trim();
                    
                    // Only auto-generate if both bidder name and code are provided
                    if (bidderName && bidderCode) {
                        // Auto-generate Order Name: 'Openwrap-' + BIDDER_NAME + '-display'
                        const orderName = `Openwrap-${bidderName}-display`;
                        document.getElementById('order_name').value = orderName;
                        
                        // Auto-generate Advertiser Name: "Network OpenWrap " + BIDDER_NAME
                        const advertiserName = `Network OpenWrap ${bidderName}`;
                        document.getElementById('advertiser_name').value = advertiserName;
                        
                        // Auto-generate Line Item Prefix: 'OpenWrap-' + BIDDER_NAME + '-display'
                        const lineItemPrefix = `OpenWrap-${bidderName}-display`;
                        document.getElementById('lineitem_prefix').value = lineItemPrefix;
                        
                        // Add visual feedback
                        showAutoGenerationFeedback();
                    } else {
                        // Clear auto-generated values if either field is empty
                        if (!bidderName && !bidderCode) {
                            document.getElementById('order_name').value = '';
                            document.getElementById('advertiser_name').value = '{{ settings.DFP_ADVERTISER_NAME }}';
                            document.getElementById('lineitem_prefix').value = '';
                        }
                    }
                }
                
                function showAutoGenerationFeedback() {
                    // Create or update feedback message
                    let feedbackDiv = document.getElementById('bidder-feedback');
                    if (!feedbackDiv) {
                        feedbackDiv = document.createElement('div');
                        feedbackDiv.id = 'bidder-feedback';
                        feedbackDiv.style.cssText = 'margin: 8px 0; padding: 8px 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; font-size: 0.9em; color: #1565c0;';
                        
                        // Insert after bidder code field
                        const bidderCodeField = document.getElementById('bidder_code').parentNode;
                        bidderCodeField.insertAdjacentElement('afterend', feedbackDiv);
                    }
                    
                    feedbackDiv.innerHTML = '‚ú® <strong>Auto-generated:</strong> Order name, advertiser name, and line item prefix have been automatically populated based on your bidder information.';
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        if (feedbackDiv) {
                            feedbackDiv.style.opacity = '0.7';
                        }
                    }, 5000);
                }

                // Currency exchange toggle functionality
                document.addEventListener('DOMContentLoaded', function() {
                    const currencyExchangeCheckbox = document.querySelector('input[name="currency_exchange"]');
                    const targetCurrencySection = document.getElementById('target_currency_section');
                    
                    function toggleTargetCurrency() {
                        if (currencyExchangeCheckbox.checked) {
                            targetCurrencySection.style.display = 'block';
                        } else {
                            targetCurrencySection.style.display = 'none';
                        }
                    }
                    
                    // Initial state
                    toggleTargetCurrency();
                    
                    // Add event listener
                    currencyExchangeCheckbox.addEventListener('change', toggleTargetCurrency);
                });
                
                function addRow() {
                    var table = document.getElementById('ranges-table').getElementsByTagName('tbody')[0];
                    var rowCount = table.rows.length;
                    var row = table.insertRow(-1);
                    row.innerHTML = `
                        <td><input type="number" step="any" name="start_range_${rowCount}" required oninput="calculateTotals()"></td>
                        <td><input type="number" step="any" name="end_range_${rowCount}" required oninput="calculateTotals()"></td>
                        <td><input type="number" step="any" name="granularity_${rowCount}" required oninput="calculateTotals()"></td>
                        <td>
                            <select name="rate_id_${rowCount}" required>
                                <option value="1">1 (Average)</option>
                                <option value="2">2 (Minimum)</option>
                            </select>
                        </td>
                        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                    `;
                    document.getElementById('ranges_count').value = rowCount + 1;
                    calculateTotals();
                }
                function removeRow(btn) {
                    var row = btn.parentNode.parentNode;
                    var table = row.parentNode;
                    table.removeChild(row);
                    // Re-index names
                    var rows = table.getElementsByTagName('tr');
                    for (var i = 0; i < rows.length; i++) {
                        var inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length > 0) inputs[0].name = 'start_range_' + i;
                        if (inputs.length > 1) inputs[1].name = 'end_range_' + i;
                        if (inputs.length > 2) inputs[2].name = 'granularity_' + i;
                        var selects = rows[i].getElementsByTagName('select');
                        if (selects.length > 0) selects[0].name = 'rate_id_' + i;
                    }
                    document.getElementById('ranges_count').value = rows.length;
                    calculateTotals();
                }
                
                function calculateTotals() {
                    const table = document.getElementById('ranges-table').getElementsByTagName('tbody')[0];
                    const rows = table.getElementsByTagName('tr');
                    let totalLineItems = 0;
                    let hasErrors = false;
                    
                    for (let i = 0; i < rows.length; i++) {
                        const inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length >= 3) {
                            const startRange = parseFloat(inputs[0].value) || 0;
                            const endRange = parseFloat(inputs[1].value) || 0;
                            const granularity = parseFloat(inputs[2].value) || 0;
                            
                            if (startRange > 0 && endRange > 0 && granularity !== 0) {
                                if (granularity === -1) {
                                    // Catch-all: one line item for the whole range
                                    totalLineItems += 1;
                                } else if (granularity > 0) {
                                    // Calculate number of buckets based on actual backend logic
                                    let current = startRange;
                                    let bucketCount = 0;
                                    while (current <= endRange + 0.00001) { // small epsilon for float precision
                                        bucketCount++;
                                        current += granularity;
                                    }
                                    totalLineItems += Math.max(1, bucketCount);
                                }
                            }
                        }
                    }
                    
                    // Get number of creatives per line item
                    const numCreativesInput = document.querySelector('input[name="num_creatives"]');
                    const numCreatives = parseInt(numCreativesInput?.value) || 1;
                    const totalCreatives = totalLineItems * numCreatives;
                    
                    // Update display
                    document.getElementById('lineitem-count').textContent = totalLineItems;
                    document.getElementById('creative-count').textContent = totalCreatives;
                    
                    // Check limits and show warnings
                    const warningsDiv = document.getElementById('limit-warnings');
                    let warnings = [];
                    
                    // Google Ad Manager limits
                    const MAX_LINE_ITEMS_PER_ORDER = 450;
                    const MAX_CREATIVES_PER_ADVERTISER = 10000;
                    
                    if (totalLineItems > MAX_LINE_ITEMS_PER_ORDER) {
                        warnings.push(`‚ö†Ô∏è <strong>Line Items Limit Exceeded:</strong> ${totalLineItems} line items exceed the maximum of ${MAX_LINE_ITEMS_PER_ORDER} per order.`);
                    }
                    
                    if (totalCreatives > MAX_CREATIVES_PER_ADVERTISER) {
                        warnings.push(`‚ö†Ô∏è <strong>Creatives Limit Exceeded:</strong> ${totalCreatives} creatives exceed the maximum of ${MAX_CREATIVES_PER_ADVERTISER} per advertiser.`);
                    }
                    
                    // Performance warnings
                    if (totalLineItems > 200) {
                        warnings.push(`üí° <strong>Performance Note:</strong> ${totalLineItems} line items may impact performance. Consider reducing granularity.`);
                    }
                    
                    if (warnings.length > 0) {
                        warningsDiv.innerHTML = warnings.map(w => `<div style="margin: 4px 0; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 0.9em;">${w}</div>`).join('');
                    } else if (totalLineItems > 0) {
                        warningsDiv.innerHTML = '<div style="margin: 4px 0; padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 0.9em; color: #155724;">‚úÖ <strong>All limits OK!</strong> Ready to create line items.</div>';
                    } else {
                        warningsDiv.innerHTML = '';
                    }
                }
                
                // Add event listeners to existing inputs
                document.addEventListener('DOMContentLoaded', function() {
                    // Add calculation triggers to existing range inputs
                    const rangeInputs = document.querySelectorAll('input[name^="start_range_"], input[name^="end_range_"], input[name^="granularity_"]');
                    rangeInputs.forEach(input => {
                        input.addEventListener('input', calculateTotals);
                    });
                    
                    // Add calculation trigger to num_creatives input
                    const numCreativesInput = document.querySelector('input[name="num_creatives"]');
                    if (numCreativesInput) {
                        numCreativesInput.addEventListener('input', calculateTotals);
                    }
                    
                    // Initial calculation
                    calculateTotals();
                });
                </script>

                <!-- Progress Bar -->
                <div id="progress-container" style="display:none; margin-bottom:18px;">
                  <div style="background:#e5e7eb; border-radius:6px; height:24px; width:100%; overflow:hidden;">
                    <div id="progress-bar" style="height:100%; width:0%; background:#0096e6; color:#fff; text-align:center; line-height:24px; font-weight:600; transition:width 0.3s; border-radius:6px;">0%</div>
                  </div>
                </div>
                <button type="button" class="submit-btn" id="submit-btn" onclick="showConfirmation()">Create Line Items</button>
            </form>
            <script>
            // Confirmation Modal Functions
            function showConfirmation() {
                // Validate form first
                if (!validateForm()) {
                    return;
                }
                
                // Generate confirmation content
                const confirmationContent = generateConfirmationContent();
                document.getElementById('confirmationContent').innerHTML = confirmationContent;
                
                // Show modal
                document.getElementById('confirmationModal').style.display = 'block';
            }
            
            function closeConfirmation() {
                document.getElementById('confirmationModal').style.display = 'none';
            }
            
            function confirmAndSubmit() {
                // Copy form data to hidden form
                copyFormData();
                
                // Show progress bar
                showProgressBar();
                
                // Submit the hidden form
                document.getElementById('hiddenForm').submit();
                
                // Close modal
                closeConfirmation();
            }
            
            function showProgressBar() {
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const submitBtn = document.getElementById('submit-btn');
                
                // Reset and show progress bar
                progress = 0;
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressContainer.style.display = 'block';
                submitBtn.disabled = true;
                
                // Add a small delay to show the progress bar starting
                setTimeout(() => {
                    // Start progress animation
                    interval = setInterval(() => {
                        if (progress < 90) {
                            progress += Math.random() * 5 + 2; // 2-7% increments
                            if (progress > 90) progress = 90;
                            progressBar.style.width = progress + '%';
                            progressBar.textContent = Math.floor(progress) + '%';
                        }
                    }, 300);
                }, 100);
            }
            
            function getRangeFixSuggestion(range1, range2) {
                // Suggest fixes for overlapping ranges
                const overlapStart = Math.max(range1.start, range2.start);
                const overlapEnd = Math.min(range1.end, range2.end);
                
                if (overlapStart === overlapEnd) {
                    // Single point overlap
                    return `Adjust Range ${range1.index} to end at $${(overlapStart - 0.01).toFixed(2)} or Range ${range2.index} to start at $${(overlapEnd + 0.01).toFixed(2)}`;
                } else {
                    // Range overlap
                    return `Option 1: Adjust Range ${range1.index} to end at $${(overlapStart - 0.01).toFixed(2)}\nOption 2: Adjust Range ${range2.index} to start at $${(overlapEnd + 0.01).toFixed(2)}\nOption 3: Use catch-all (granularity -1) for one of the ranges`;
                }
            }
            
            function checkForOverlaps(ranges) {
                // Check if any ranges overlap (excluding catch-all ranges)
                for (let i = 0; i < ranges.length; i++) {
                    for (let j = i + 1; j < ranges.length; j++) {
                        const range1 = ranges[i];
                        const range2 = ranges[j];
                        
                        // Skip catch-all ranges
                        if (range1.granularity === -1 || range2.granularity === -1) {
                            continue;
                        }
                        
                        // Check if ranges overlap
                        if (!(range1.end <= range2.start || range2.end <= range1.start)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            function validateForm() {
                const requiredFields = [
                    'order_name', 'user_email', 'advertiser_name', 
                    'network_code', 'lineitem_type', 'creative_sizes'
                ];
                
                for (const fieldName of requiredFields) {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        alert(`Please fill in the required field: ${fieldName.replace('_', ' ')}`);
                        field?.focus();
                        return false;
                    }
                }
                
                // Check if at least one price range is defined
                const rangesTable = document.getElementById('ranges-table');
                if (rangesTable) {
                    const rows = rangesTable.getElementsByTagName('tbody')[0].rows;
                    if (rows.length === 0) {
                        alert('Please add at least one price range.');
                        return false;
                    }
                    
                    // Validate each range
                    for (let i = 0; i < rows.length; i++) {
                        const inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length >= 3) {
                            const start = parseFloat(inputs[0].value);
                            const end = parseFloat(inputs[1].value);
                            const granularity = parseFloat(inputs[2].value);
                            
                            if (isNaN(start) || isNaN(end) || isNaN(granularity)) {
                                alert(`Please fill in all fields for price range ${i + 1}.`);
                                return false;
                            }
                            
                            if (start >= end) {
                                alert(`Start range must be less than end range for price range ${i + 1}.`);
                                return false;
                            }
                            
                            if (granularity !== -1 && granularity <= 0) {
                                alert(`Granularity must be -1 (catch-all) or greater than 0 for price range ${i + 1}.`);
                                return false;
                            }
                        }
                    }
                    
                    // Check for overlapping ranges
                    const ranges = [];
                    for (let i = 0; i < rows.length; i++) {
                        const inputs = rows[i].getElementsByTagName('input');
                        if (inputs.length >= 3) {
                            const start = parseFloat(inputs[0].value);
                            const end = parseFloat(inputs[1].value);
                            const granularity = parseFloat(inputs[2].value);
                            
                            if (granularity !== -1) {
                                ranges.push({ start, end, index: i + 1 });
                            }
                        }
                    }
                    
                    // Check for overlaps
                    for (let i = 0; i < ranges.length; i++) {
                        for (let j = i + 1; j < ranges.length; j++) {
                            const range1 = ranges[i];
                            const range2 = ranges[j];
                            
                            // Check if ranges overlap
                            if (!(range1.end <= range2.start || range2.end <= range1.start)) {
                                const suggestion = getRangeFixSuggestion(range1, range2);
                                alert(`‚ö†Ô∏è OVERLAPPING RANGES DETECTED!\n\nRange ${range1.index}: $${range1.start} to $${range1.end}\nRange ${range2.index}: $${range2.start} to $${range2.end}\n\nThis will create duplicate line item names.\n\nüí° SUGGESTED FIX:\n${suggestion}\n\nPlease adjust your ranges to avoid overlap.`);
                                return false;
                            }
                        }
                    }
                }
                
                return true;
            }
            
            function generateConfirmationContent() {
                const form = document.querySelector('form');
                const formData = new FormData(form);
                
                // Get basic form data
                const orderName = formData.get('order_name');
                const advertiserName = formData.get('advertiser_name');
                const lineItemType = formData.get('lineitem_type');
                const setupType = formData.get('openwrap_setup_type');
                const lineItemPrefix = formData.get('lineitem_prefix') || 'None';
                const numCreatives = formData.get('num_creatives') || '1';
                const creativeSizes = formData.get('creative_sizes');
                const currencyCode = formData.get('currency_code') || 'USD';
                const currencyExchange = formData.get('currency_exchange') === 'on';
                const targetCurrency = formData.get('target_currency') || 'INR';
                
                // Get price ranges
                const rangesTable = document.getElementById('ranges-table');
                let priceRanges = [];
                let totalLineItems = 0;
                
                if (rangesTable) {
                    const rows = rangesTable.getElementsByTagName('tbody')[0].rows;
                    for (let i = 0; i < rows.length; i++) {
                        const inputs = rows[i].getElementsByTagName('input');
                        const selects = rows[i].getElementsByTagName('select');
                        
                        if (inputs.length >= 3) {
                            const start = parseFloat(inputs[0].value);
                            const end = parseFloat(inputs[1].value);
                            const granularity = parseFloat(inputs[2].value);
                            const rateId = selects[0]?.value || '1';
                            
                            priceRanges.push({
                                start: start,
                                end: end,
                                granularity: granularity,
                                rateId: rateId
                            });
                            
                            // Calculate line items for this range
                            if (granularity === -1) {
                                totalLineItems += 1; // Catch-all creates 1 line item
                            } else {
                                let current = start;
                                let bucketCount = 0;
                                while (current <= end + 0.00001) {
                                    bucketCount++;
                                    current += granularity;
                                }
                                totalLineItems += Math.max(1, bucketCount);
                            }
                        }
                    }
                }
                
                // Generate price targeting values (similar to PyCharm output)
                let priceTargetingValues = [];
                for (const range of priceRanges) {
                    if (range.granularity === -1) {
                        // Catch-all range - show start price
                        priceTargetingValues.push(range.start.toFixed(2));
                    } else {
                        // Regular range - generate all values
                        let current = range.start;
                        while (current <= range.end + 0.00001) {
                            priceTargetingValues.push(current.toFixed(2));
                            current += range.granularity;
                        }
                    }
                }
                
                // Limit to first 50 values for display
                const displayValues = priceTargetingValues.slice(0, 50);
                const hasMore = priceTargetingValues.length > 50;
                
                let content = `
                    <div class="confirmation-summary">
                        <h4>üìä Summary</h4>
                        <p><strong>Going to create ${totalLineItems} new line items.</strong></p>
                        <p><strong>Total Creatives:</strong> ${totalLineItems * parseInt(numCreatives)}</p>
                    </div>
                    
                    <div class="confirmation-details">
                        <h4>üìã Order Details</h4>
                        <p><strong>Order:</strong> ${orderName}</p>
                        <p><strong>Advertiser:</strong> ${advertiserName}</p>
                        <p><strong>Line Item Type:</strong> ${lineItemType}</p>
                        <p><strong>Line Item Prefix:</strong> ${lineItemPrefix}</p>
                        <p><strong>Setup Type:</strong> ${setupType}</p>
                        <p><strong>Creative Sizes:</strong> ${creativeSizes}</p>
                        <p><strong>Creatives per Line Item:</strong> ${numCreatives}</p>
                        <p><strong>Currency:</strong> ${currencyExchange ? `${currencyCode} ‚Üí ${targetCurrency}` : currencyCode}</p>
                    </div>
                    
                    <div class="confirmation-details">
                        <h4>üí∞ Price Granularity Ranges</h4>
                        <table class="confirmation-table">
                            <thead>
                                <tr>
                                    <th>Start Range</th>
                                    <th>End Range</th>
                                    <th>Granularity</th>
                                    <th>Rate ID</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const range of priceRanges) {
                    const granularityDisplay = range.granularity === -1 ? '-1 (Catch-all)' : range.granularity.toFixed(2);
                    content += `
                        <tr>
                            <td>${range.start.toFixed(2)}</td>
                            <td>${range.end.toFixed(2)}</td>
                            <td>${granularityDisplay}</td>
                            <td>${range.rateId}</td>
                        </tr>`;
                }
                
                content += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="confirmation-details">
                        <h4>üéØ Line Items Will Have Targeting</h4>
                        <p><strong>rates =</strong> [${displayValues.join(', ')}${hasMore ? ', ...' : ''}]</p>
                        <p><strong>bidders =</strong> None</p>
                        <p><strong>placements =</strong> RON (Run of Network)</p>
                        <p><strong>custom targeting =</strong> OpenWrap targeting keys</p>
                        <p><strong>same advertiser exception =</strong> False</p>
                        <p><strong>device categories =</strong> None</p>
                        <p><strong>device capabilities =</strong> None</p>
                        <p><strong>roadblock type =</strong> ONE_OR_MORE</p>
                        <p><strong>video position type =</strong> None</p>
                    </div>
                    
                    <div class="confirmation-warning">
                        <h4>‚ö†Ô∏è Important Notes</h4>
                        <p>‚Ä¢ This will create ${totalLineItems} line items in Google Ad Manager</p>
                        <p>‚Ä¢ Each line item will have ${numCreatives} creative(s)</p>
                        <p>‚Ä¢ Line items will target specific price points with OpenWrap targeting</p>
                        <p>‚Ä¢ Process cannot be undone once started</p>
                    </div>
                    
                    ${checkForOverlaps(priceRanges) ? `
                    <div class="confirmation-warning" style="background: #f8d7da; border-color: #f5c6cb;">
                        <h4>üö® OVERLAP WARNING</h4>
                        <p>‚Ä¢ Some price ranges may overlap, creating duplicate line item names</p>
                        <p>‚Ä¢ This could cause errors during creation</p>
                        <p>‚Ä¢ Consider adjusting ranges or using catch-all granularity (-1)</p>
                    </div>
                    ` : ''}
                `;
                
                return content;
            }
            
            function copyFormData() {
                const originalForm = document.querySelector('form');
                const hiddenForm = document.getElementById('hiddenForm');
                
                // Clear existing content
                hiddenForm.innerHTML = '';
                
                // Copy all form elements
                const formElements = originalForm.elements;
                for (let i = 0; i < formElements.length; i++) {
                    const element = formElements[i];
                    if (element.name && element.type !== 'button') {
                        if (element.type === 'checkbox') {
                            if (element.checked) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = element.name;
                                hiddenInput.value = element.value;
                                hiddenForm.appendChild(hiddenInput);
                            }
                        } else {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = element.name;
                            hiddenInput.value = element.value;
                            hiddenForm.appendChild(hiddenInput);
                        }
                    }
                }
                
                // Log the copied data for debugging
                console.log('Form data copied to hidden form:', hiddenForm.innerHTML);
            }
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('confirmationModal');
                if (event.target === modal) {
                    closeConfirmation();
                }
            }
            
            // Progress bar variables (used by confirmation modal)
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const submitBtn = document.getElementById('submit-btn');
            let progress = 0;
            let interval = null;
            // On page load, if progress bar is visible, set to 100%
            window.addEventListener('pageshow', function() {
                if (progressContainer.style.display === 'block') {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    submitBtn.disabled = false;
                }
            });
            
            // Function to complete progress bar (called after successful form submission)
            function completeProgressBar() {
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                submitBtn.disabled = false;
                
                // Hide progress bar after a short delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
            </script>
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  {% if category == 'success' %}
                    <div style="margin: 18px 0; padding: 12px; background: #e6f7e6; color: #207520; border-radius: 6px; font-size: 1.08em; font-weight: 500;">
                      {{ message }}
                    </div>
                    <script>
                      // Complete progress bar when success message is shown
                      if (typeof completeProgressBar === 'function') {
                        completeProgressBar();
                      }
                    </script>
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Line Item Creation Confirmation</h3>
                <span class="close" onclick="closeConfirmation()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="confirmationContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmation()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAndSubmit()">‚úÖ Yes, Create Line Items</button>
            </div>
        </div>
    </div>

    <!-- Hidden form for actual submission -->
    <form id="hiddenForm" method="POST" enctype="multipart/form-data" style="display: none;">
        <!-- All form fields will be copied here -->
    </form>
</body>
</html>
